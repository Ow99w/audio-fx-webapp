<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Audio FX Editor</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;500;700&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #14141f;
    --surface2: #1e1e2e;
    --accent: #7c5cfc;
    --accent-glow: rgba(124, 92, 252, 0.3);
    --text: #e8e6f0;
    --text-dim: #7a7890;
    --border: #2a2a3e;
    --track-bg: #2a2a3e;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Outfit', sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100vh; overflow-x: hidden;
    padding: 0 16px 40px;
    -webkit-user-select: none; user-select: none;
  }

  body::before {
    content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(ellipse at 30% 20%, rgba(124,92,252,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(252,92,140,0.05) 0%, transparent 50%);
    pointer-events: none; z-index: 0;
  }

  .wrap { position: relative; z-index: 1; max-width: 420px; margin: 0 auto; }

  .header { text-align: center; padding: 20px 0 12px; }
  .header h1 {
    font-size: 22px; font-weight: 700;
    background: linear-gradient(135deg, #e8e6f0 30%, #a855f7);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .header p { font-size: 13px; color: var(--text-dim); margin-top: 4px; }

  .wave-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 16px; margin-bottom: 16px;
    position: relative; overflow: hidden;
  }
  .wave-box::after {
    content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(90deg, transparent 49.5%, var(--accent) 49.5%, var(--accent) 50.5%, transparent 50.5%);
    opacity: 0.5; pointer-events: none;
  }
  #waveCanvas { width: 100%; height: 70px; display: block; border-radius: 8px; }

  .chips {
    display: flex; gap: 8px; overflow-x: auto; padding: 0 0 14px;
    scrollbar-width: none;
  }
  .chips::-webkit-scrollbar { display: none; }
  .chip {
    flex-shrink: 0; padding: 8px 14px; border-radius: 20px;
    border: 1px solid var(--border); background: var(--surface);
    color: var(--text-dim); font-size: 13px; font-weight: 500;
    white-space: nowrap; cursor: pointer; transition: all 0.2s;
  }
  .chip.on {
    border-color: var(--accent); color: var(--text);
    background: var(--surface2); box-shadow: 0 0 12px var(--accent-glow);
  }

  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 14px 16px; margin-bottom: 10px;
  }
  .card-top { display: flex; align-items: center; margin-bottom: 12px; gap: 10px; }
  .ico {
    width: 28px; height: 28px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center; font-size: 15px; flex-shrink: 0;
  }
  .ico-pitch  { background: rgba(124,92,252,0.15); }
  .ico-speed  { background: rgba(252,165,92,0.15); }
  .ico-reverb { background: rgba(92,200,252,0.15); }
  .ico-bass   { background: rgba(252,92,140,0.15); }
  .card-label { font-size: 14px; font-weight: 500; flex-grow: 1; }
  .card-val {
    font-family: 'JetBrains Mono', monospace; font-size: 15px; font-weight: 600;
    color: var(--accent); min-width: 45px; text-align: right;
  }
  .rst {
    padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border);
    background: transparent; color: var(--text-dim); font-size: 13px;
    cursor: pointer; flex-shrink: 0;
  }

  .trk {
    position: relative; height: 44px; touch-action: none; cursor: pointer;
  }
  .trk-bg {
    position: absolute; left: 0; right: 0; height: 6px;
    background: var(--track-bg); border-radius: 3px; top: 50%; transform: translateY(-50%);
  }
  .trk-fill {
    position: absolute; left: 0; height: 6px;
    background: linear-gradient(90deg, #7c5cfc, #a855f7);
    border-radius: 3px; top: 50%; transform: translateY(-50%); width: 0;
    pointer-events: none;
  }
  .trk-knob {
    position: absolute; width: 24px; height: 24px; border-radius: 50%;
    background: var(--accent); border: 2px solid #fff;
    box-shadow: 0 0 10px var(--accent-glow), 0 2px 8px rgba(0,0,0,0.3);
    top: 50%; transform: translate(-50%, -50%); z-index: 5;
    pointer-events: none; transition: transform 0.1s;
  }
  .trk-knob.big { transform: translate(-50%, -50%) scale(1.25); }

  .trk-lim {
    display: flex; justify-content: space-between;
    font-size: 11px; color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace; margin-top: 2px;
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="header">
    <h1>üéõ Audio FX Editor</h1>
    <p>–ù–∞—Å—Ç—Ä–æ–π –∑–≤—É—á–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤—å –≤ —á–∞—Ç</p>
  </div>

  <div class="wave-box">
    <canvas id="waveCanvas"></canvas>
  </div>

  <div class="chips">
    <div class="chip" data-pk="slowed_reverb">üêå Slowed+Reverb</div>
    <div class="chip" data-pk="nightcore">üå∏ Nightcore</div>
    <div class="chip" data-pk="bass_boost">üîä Bass Boost</div>
    <div class="chip" data-pk="8d">üéß 8D Audio</div>
    <div class="chip" data-pk="chipmunk">üêø Chipmunk</div>
  </div>

  <!-- Pitch -->
  <div class="card">
    <div class="card-top">
      <span class="ico ico-pitch">üó£</span>
      <span class="card-label">–¢–æ–Ω / Pitch</span>
      <span class="card-val" id="val-pitch">1.00</span>
      <button class="rst" data-key="pitch">‚Ü∫</button>
    </div>
    <div class="trk" id="trk-pitch">
      <div class="trk-bg"></div>
      <div class="trk-fill" id="fill-pitch"></div>
      <div class="trk-knob" id="knob-pitch"></div>
    </div>
    <div class="trk-lim"><span>0.50</span><span>1.50</span></div>
  </div>

  <!-- Speed -->
  <div class="card">
    <div class="card-top">
      <span class="ico ico-speed">üöÄ</span>
      <span class="card-label">–°–∫–æ—Ä–æ—Å—Ç—å / Speed</span>
      <span class="card-val" id="val-speed">1.0</span>
      <button class="rst" data-key="speed">‚Ü∫</button>
    </div>
    <div class="trk" id="trk-speed">
      <div class="trk-bg"></div>
      <div class="trk-fill" id="fill-speed"></div>
      <div class="trk-knob" id="knob-speed"></div>
    </div>
    <div class="trk-lim"><span>0.5</span><span>2.0</span></div>
  </div>

  <!-- Reverb -->
  <div class="card">
    <div class="card-top">
      <span class="ico ico-reverb">üèõ</span>
      <span class="card-label">–†–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—è / Reverb</span>
      <span class="card-val" id="val-reverb">0</span>
      <button class="rst" data-key="reverb">‚Ü∫</button>
    </div>
    <div class="trk" id="trk-reverb">
      <div class="trk-bg"></div>
      <div class="trk-fill" id="fill-reverb"></div>
      <div class="trk-knob" id="knob-reverb"></div>
    </div>
    <div class="trk-lim"><span>0</span><span>30</span></div>
  </div>

  <!-- Bass -->
  <div class="card">
    <div class="card-top">
      <span class="ico ico-bass">üé∏</span>
      <span class="card-label">Bass Boost</span>
      <span class="card-val" id="val-bass">0</span>
      <button class="rst" data-key="bass">‚Ü∫</button>
    </div>
    <div class="trk" id="trk-bass">
      <div class="trk-bg"></div>
      <div class="trk-fill" id="fill-bass"></div>
      <div class="trk-knob" id="knob-bass"></div>
    </div>
    <div class="trk-lim"><span>0</span><span>15</span></div>
  </div>
</div>

<script>
/* ========== TELEGRAM ========== */
var tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
if (tg) {
  tg.expand();
  tg.ready();
  try {
    tg.MainButton.setText('‚ú® –ü—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç—ã');
    tg.MainButton.color = '#7c5cfc';
    tg.MainButton.textColor = '#ffffff';
    tg.MainButton.show();
    tg.MainButton.enable();
    tg.MainButton.onClick(function() { doApply(); });
  } catch(e) {}
}

/* ========== CONFIG ========== */
var SLIDERS = [
  { key:'pitch',  mn:50, mx:150, step:5, def:100, fmt:function(v){return (v/100).toFixed(2)} },
  { key:'speed',  mn:5,  mx:20,  step:1, def:10,  fmt:function(v){return (v/10).toFixed(1)} },
  { key:'reverb', mn:0,  mx:30,  step:1, def:0,   fmt:function(v){return String(v)} },
  { key:'bass',   mn:0,  mx:15,  step:1, def:0,   fmt:function(v){return String(v)} }
];

var PRESETS = {
  slowed_reverb: {pitch:85,  speed:10, reverb:15, bass:0},
  nightcore:     {pitch:125, speed:10, reverb:0,  bass:0},
  bass_boost:    {pitch:100, speed:10, reverb:0,  bass:12},
  '8d':          {pitch:100, speed:10, reverb:10, bass:3},
  chipmunk:      {pitch:150, speed:10, reverb:0,  bass:0}
};

var val = {};
var dom = {};

/* ========== INIT DOM REFS ========== */
for (var i = 0; i < SLIDERS.length; i++) {
  var S = SLIDERS[i];
  val[S.key] = S.def;
  dom[S.key] = {
    valEl:   document.getElementById('val-' + S.key),
    fillEl:  document.getElementById('fill-' + S.key),
    knobEl:  document.getElementById('knob-' + S.key),
    trackEl: document.getElementById('trk-' + S.key)
  };
}

/* ========== PRESET CHIPS ========== */
var chips = document.querySelectorAll('.chip');
for (var ci = 0; ci < chips.length; ci++) {
  (function(el) {
    el.addEventListener('click', function() {
      var pk = el.getAttribute('data-pk');
      var p = PRESETS[pk];
      if (p) { for (var k in p) { setVal(k, p[k]); } }
    });
  })(chips[ci]);
}

/* ========== RESET BUTTONS ========== */
var rstBtns = document.querySelectorAll('.rst');
for (var ri = 0; ri < rstBtns.length; ri++) {
  (function(btn) {
    btn.addEventListener('click', function() {
      var key = btn.getAttribute('data-key');
      var cfg = getCfg(key);
      if (cfg) setVal(key, cfg.def);
    });
  })(rstBtns[ri]);
}

/* ========== TOUCH/MOUSE BINDINGS ========== */
for (var ti = 0; ti < SLIDERS.length; ti++) {
  (function(key) {
    var trackEl = dom[key].trackEl;
    var knobEl = dom[key].knobEl;

    trackEl.addEventListener('touchstart', function(e) {
      e.preventDefault(); e.stopPropagation();
      knobEl.classList.add('big');
      moveSlider(key, e.touches[0].clientX, trackEl);
    }, {passive: false});

    trackEl.addEventListener('touchmove', function(e) {
      e.preventDefault(); e.stopPropagation();
      moveSlider(key, e.touches[0].clientX, trackEl);
    }, {passive: false});

    trackEl.addEventListener('touchend', function() { knobEl.classList.remove('big'); });
    trackEl.addEventListener('touchcancel', function() { knobEl.classList.remove('big'); });

    var mouseDown = false;
    trackEl.addEventListener('mousedown', function(e) {
      e.preventDefault(); mouseDown = true;
      knobEl.classList.add('big');
      moveSlider(key, e.clientX, trackEl);
    });
    document.addEventListener('mousemove', function(e) {
      if (!mouseDown) return;
      moveSlider(key, e.clientX, trackEl);
    });
    document.addEventListener('mouseup', function() {
      if (mouseDown) { mouseDown = false; knobEl.classList.remove('big'); }
    });
  })(SLIDERS[ti].key);
}

/* ========== SLIDER LOGIC ========== */
function getCfg(key) {
  for (var i = 0; i < SLIDERS.length; i++) {
    if (SLIDERS[i].key === key) return SLIDERS[i];
  }
  return null;
}

function moveSlider(key, clientX, trackEl) {
  var rect = trackEl.getBoundingClientRect();
  var pct = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
  var cfg = getCfg(key);
  var raw = cfg.mn + pct * (cfg.mx - cfg.mn);
  var snapped = Math.round(raw / cfg.step) * cfg.step;
  setVal(key, Math.max(cfg.mn, Math.min(cfg.mx, snapped)));
}

function setVal(key, v) {
  var cfg = getCfg(key);
  v = Math.max(cfg.mn, Math.min(cfg.mx, Math.round(v / cfg.step) * cfg.step));
  val[key] = v;

  var pct = (v - cfg.mn) / (cfg.mx - cfg.mn) * 100;
  var d = dom[key];
  d.fillEl.style.width = pct + '%';
  d.knobEl.style.left = pct + '%';
  d.valEl.textContent = cfg.fmt(v);

  drawWave();
  hiliteChips();
  updateBtn();
}

/* ========== PRESETS HIGHLIGHT ========== */
function hiliteChips() {
  for (var i = 0; i < chips.length; i++) {
    var pk = chips[i].getAttribute('data-pk');
    var p = PRESETS[pk];
    if (!p) continue;
    var ok = true;
    for (var k in p) { if (Math.abs(val[k] - p[k]) > 1) { ok = false; break; } }
    chips[i].classList.toggle('on', ok);
  }
}

/* ========== MAIN BUTTON ========== */
function isDefault() {
  for (var i = 0; i < SLIDERS.length; i++) {
    if (val[SLIDERS[i].key] !== SLIDERS[i].def) return false;
  }
  return true;
}

function updateBtn() {
  if (!tg) return;
  try { tg.MainButton.color = isDefault() ? '#3a3a4e' : '#7c5cfc'; } catch(e) {}
}

function doApply() {
  if (isDefault()) {
    var msg = '–ò–∑–º–µ–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä';
    if (tg) { try { tg.showAlert(msg); } catch(e) { alert(msg); } }
    else { alert(msg); }
    return;
  }

  var data = JSON.stringify({
    pitch: Number((val.pitch / 100).toFixed(2)),
    speed: Number((val.speed / 10).toFixed(1)),
    reverb: val.reverb,
    bass: val.bass
  });

  if (tg) {
    try { tg.sendData(data); } catch(e) { alert('–û—à–∏–±–∫–∞: ' + e.message); }
  } else {
    alert('–î–∞–Ω–Ω—ã–µ: ' + data);
  }
}

/* ========== WAVEFORM ========== */
var wCanvas = document.getElementById('waveCanvas');
var wCtx = wCanvas.getContext('2d');
var wData = [];

function initWave() {
  var dpr = window.devicePixelRatio || 1;
  var w = wCanvas.offsetWidth;
  var h = wCanvas.offsetHeight;
  wCanvas.width = w * dpr;
  wCanvas.height = h * dpr;
  wCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

  wData = [];
  for (var i = 0; i < w; i++) {
    var t = i / w;
    var a = 0.3 + 0.7 * (
      Math.sin(t*12)*0.3 + Math.sin(t*28+1)*0.25 +
      Math.sin(t*60)*0.15 + Math.sin(t*120)*0.1 + Math.random()*0.2
    );
    wData.push(Math.max(0.05, Math.min(1, a)));
  }
  drawWave();
}

function drawWave() {
  var w = wCanvas.offsetWidth;
  var h = wCanvas.offsetHeight;
  wCtx.clearRect(0, 0, w, h);

  var pF = val.pitch / 100;
  var sF = val.speed / 10;
  var bF = val.bass / 15;
  var rF = val.reverb / 30;

  for (var i = 0; i < w; i++) {
    var si = Math.floor((i * sF) % wData.length);
    var a = wData[si] * pF;
    a += bF * 0.3 * Math.sin(i * 0.02);
    a = Math.max(0.02, Math.min(1, a));

    var bH = a * h * 0.85;
    var y = (h - bH) / 2;

    if (rF > 0) {
      wCtx.fillStyle = 'rgba(124,92,252,' + (rF*0.15) + ')';
      var eH = a * rF * 0.4 * h * 0.85;
      wCtx.fillRect(i, (h-eH)/2, 1, eH);
    }

    var g = wCtx.createLinearGradient(0, y, 0, y+bH);
    g.addColorStop(0, 'rgba(124,92,252,' + (0.5+a*0.5) + ')');
    g.addColorStop(0.5, 'rgba(168,85,247,' + (0.7+a*0.3) + ')');
    g.addColorStop(1, 'rgba(252,92,140,' + (0.3+bF*0.5) + ')');
    wCtx.fillStyle = g;
    wCtx.fillRect(i, y, 1, bH);
  }
}

/* ========== INIT ========== */
window.addEventListener('resize', initWave);
initWave();
for (var i = 0; i < SLIDERS.length; i++) { setVal(SLIDERS[i].key, SLIDERS[i].def); }
</script>
</body>
</html>
