<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Audio FX Editor</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;500;700&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #14141f;
    --surface2: #1e1e2e;
    --accent: #7c5cfc;
    --accent-glow: rgba(124, 92, 252, 0.3);
    --text: #e8e6f0;
    --text-dim: #7a7890;
    --border: #2a2a3e;
    --track-bg: #2a2a3e;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Outfit', sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100vh; overflow-x: hidden;
    padding: 0 16px 40px;
    -webkit-user-select: none; user-select: none;
  }

  body::before {
    content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(ellipse at 30% 20%, rgba(124,92,252,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(252,92,140,0.05) 0%, transparent 50%);
    pointer-events: none; z-index: 0;
  }

  .wrap { position: relative; z-index: 1; max-width: 420px; margin: 0 auto; }

  .header { text-align: center; padding: 20px 0 12px; }
  .header h1 {
    font-size: 22px; font-weight: 700;
    background: linear-gradient(135deg, #e8e6f0 30%, #a855f7);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .header p { font-size: 13px; color: var(--text-dim); margin-top: 4px; }

  .wave-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 16px; margin-bottom: 16px;
    position: relative; overflow: hidden;
  }
  .wave-box::after {
    content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(90deg, transparent 49.5%, var(--accent) 49.5%, var(--accent) 50.5%, transparent 50.5%);
    opacity: 0.5; pointer-events: none;
  }
  #waveCanvas { width: 100%; height: 70px; display: block; border-radius: 8px; }

  .chips {
    display: flex; gap: 8px; overflow-x: auto; padding: 0 0 14px;
    scrollbar-width: none;
  }
  .chips::-webkit-scrollbar { display: none; }
  .chip {
    flex-shrink: 0; padding: 8px 14px; border-radius: 20px;
    border: 1px solid var(--border); background: var(--surface);
    color: var(--text-dim); font-size: 13px; font-weight: 500;
    white-space: nowrap; cursor: pointer; transition: all 0.2s;
  }
  .chip.on {
    border-color: var(--accent); color: var(--text);
    background: var(--surface2); box-shadow: 0 0 12px var(--accent-glow);
  }

  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 14px 16px; margin-bottom: 10px;
  }
  .card-top { display: flex; align-items: center; margin-bottom: 12px; gap: 10px; }
  .ico {
    width: 28px; height: 28px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center; font-size: 15px; flex-shrink: 0;
  }
  .ico-pitch  { background: rgba(124,92,252,0.15); }
  .ico-speed  { background: rgba(252,165,92,0.15); }
  .ico-reverb { background: rgba(92,200,252,0.15); }
  .ico-bass   { background: rgba(252,92,140,0.15); }
  .card-label { font-size: 14px; font-weight: 500; flex-grow: 1; }
  .card-val {
    font-family: 'JetBrains Mono', monospace; font-size: 15px; font-weight: 600;
    color: var(--accent); min-width: 45px; text-align: right;
  }
  .rst {
    padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border);
    background: transparent; color: var(--text-dim); font-size: 13px;
    cursor: pointer; flex-shrink: 0;
  }

  .trk {
    position: relative; height: 44px; touch-action: none; cursor: pointer;
  }
  .trk-bg {
    position: absolute; left: 0; right: 0; height: 6px;
    background: var(--track-bg); border-radius: 3px; top: 50%; transform: translateY(-50%);
  }
  .trk-fill {
    position: absolute; left: 0; height: 6px;
    background: linear-gradient(90deg, #7c5cfc, #a855f7);
    border-radius: 3px; top: 50%; transform: translateY(-50%); width: 0;
    pointer-events: none;
  }
  .trk-knob {
    position: absolute; width: 24px; height: 24px; border-radius: 50%;
    background: var(--accent); border: 2px solid #fff;
    box-shadow: 0 0 10px var(--accent-glow), 0 2px 8px rgba(0,0,0,0.3);
    top: 50%; transform: translate(-50%, -50%); z-index: 5;
    pointer-events: none; transition: transform 0.1s;
  }
  .trk-knob.big { transform: translate(-50%, -50%) scale(1.25); }

  .trk-lim {
    display: flex; justify-content: space-between;
    font-size: 11px; color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace; margin-top: 2px;
  }

  #dbg {
    position: fixed; bottom: 60px; left: 10px; right: 10px;
    font-size: 11px; color: #0f0; font-family: monospace;
    background: rgba(0,0,0,0.8); padding: 6px 10px; border-radius: 8px;
    display: none; z-index: 999; max-height: 80px; overflow: auto;
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="header">
    <h1>üéõ Audio FX Editor</h1>
    <p>–ù–∞—Å—Ç—Ä–æ–π –∑–≤—É—á–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤—å –≤ —á–∞—Ç</p>
  </div>

  <div class="wave-box">
    <canvas id="waveCanvas"></canvas>
  </div>

  <div class="chips" id="chips"></div>
  <div id="cards"></div>
</div>

<div id="dbg"></div>

<script>
/* ========== DEBUG ========== */
var dbgEl = document.getElementById('dbg');
function dbg(s) {
  // dbgEl.style.display = 'block';
  // dbgEl.textContent = s;
  console.log('[FX]', s);
}

/* ========== TELEGRAM ========== */
var tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
if (tg) {
  tg.expand();
  tg.ready();
  try {
    tg.MainButton.setText('‚ú® –ü—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç—ã');
    tg.MainButton.color = '#7c5cfc';
    tg.MainButton.textColor = '#ffffff';
    tg.MainButton.show();
    tg.MainButton.enable();
    tg.MainButton.onClick(function() { doApply(); });
    dbg('MainButton initialized');
  } catch(e) {
    dbg('MainButton error: ' + e.message);
  }
}

/* ========== CONFIG ========== */
var SLIDERS = [
  { key:'pitch',  icon:'üó£', cls:'ico-pitch',  label:'–¢–æ–Ω / Pitch',          mn:50, mx:150, step:5, def:100, fmt:function(v){return (v/100).toFixed(2)} },
  { key:'speed',  icon:'üöÄ', cls:'ico-speed',  label:'–°–∫–æ—Ä–æ—Å—Ç—å / Speed',     mn:5,  mx:20,  step:1, def:10,  fmt:function(v){return (v/10).toFixed(1)} },
  { key:'reverb', icon:'üèõ', cls:'ico-reverb', label:'–†–µ–≤–µ—Ä–±–µ—Ä–∞—Ü–∏—è / Reverb', mn:0,  mx:30,  step:1, def:0,   fmt:function(v){return String(v)} },
  { key:'bass',   icon:'üé∏', cls:'ico-bass',   label:'Bass Boost',           mn:0,  mx:15,  step:1, def:0,   fmt:function(v){return String(v)} }
];

var PRESETS = {
  slowed_reverb: {pitch:85,  speed:10, reverb:15, bass:0},
  nightcore:     {pitch:125, speed:10, reverb:0,  bass:0},
  bass_boost:    {pitch:100, speed:10, reverb:0,  bass:12},
  '8d':          {pitch:100, speed:10, reverb:10, bass:3},
  chipmunk:      {pitch:150, speed:10, reverb:0,  bass:0}
};

var PRESET_LABELS = {
  slowed_reverb:'üêå Slowed+Reverb', nightcore:'üå∏ Nightcore',
  bass_boost:'üîä Bass Boost', '8d':'üéß 8D Audio', chipmunk:'üêø Chipmunk'
};

var val = {};   // current values: {pitch:100, speed:10, ...}
var dom = {};   // DOM refs per key: {pitch: {valEl, fillEl, knobEl, trackEl}, ...}

/* ========== BUILD UI ========== */
var cardsDiv = document.getElementById('cards');
var chipsDiv = document.getElementById('chips');

// Build preset chips
var presetKeys = ['slowed_reverb','nightcore','bass_boost','8d','chipmunk'];
for (var pi = 0; pi < presetKeys.length; pi++) {
  var pk = presetKeys[pi];
  var chipEl = document.createElement('div');
  chipEl.className = 'chip';
  chipEl.setAttribute('data-pk', pk);
  chipEl.textContent = PRESET_LABELS[pk];
  chipsDiv.appendChild(chipEl);
  (function(key, el) {
    el.addEventListener('click', function() {
      var p = PRESETS[key];
      for (var k in p) { setVal(k, p[k]); }
    });
  })(pk, chipEl);
}

// Build slider cards
for (var si = 0; si < SLIDERS.length; si++) {
  var S = SLIDERS[si];
  val[S.key] = S.def;

  var card = document.createElement('div');
  card.className = 'card';

  // Header row
  var top = document.createElement('div');
  top.className = 'card-top';

  var ico = document.createElement('span');
  ico.className = 'ico ' + S.cls;
  ico.textContent = S.icon;

  var lbl = document.createElement('span');
  lbl.className = 'card-label';
  lbl.textContent = S.label;

  var valSpan = document.createElement('span');
  valSpan.className = 'card-val';
  valSpan.textContent = S.fmt(S.def);

  var rstBtn = document.createElement('button');
  rstBtn.className = 'rst';
  rstBtn.textContent = '‚Ü∫';

  top.appendChild(ico);
  top.appendChild(lbl);
  top.appendChild(valSpan);
  top.appendChild(rstBtn);

  // Track
  var track = document.createElement('div');
  track.className = 'trk';

  var bg = document.createElement('div');
  bg.className = 'trk-bg';

  var fill = document.createElement('div');
  fill.className = 'trk-fill';

  var knob = document.createElement('div');
  knob.className = 'trk-knob';

  track.appendChild(bg);
  track.appendChild(fill);
  track.appendChild(knob);

  // Limits
  var lim = document.createElement('div');
  lim.className = 'trk-lim';
  var limL = document.createElement('span');
  limL.textContent = S.fmt(S.mn);
  var limR = document.createElement('span');
  limR.textContent = S.fmt(S.mx);
  lim.appendChild(limL);
  lim.appendChild(limR);

  card.appendChild(top);
  card.appendChild(track);
  card.appendChild(lim);
  cardsDiv.appendChild(card);

  // Store direct DOM references
  dom[S.key] = { valEl: valSpan, fillEl: fill, knobEl: knob, trackEl: track };

  // Reset handler
  (function(key) {
    rstBtn.addEventListener('click', function() {
      var cfg = getCfg(key);
      setVal(key, cfg.def);
    });
  })(S.key);

  // Bind touch/mouse directly on this track
  (function(key, trackEl, knobEl) {
    trackEl.addEventListener('touchstart', function(e) {
      e.preventDefault();
      e.stopPropagation();
      knobEl.classList.add('big');
      var touch = e.touches[0];
      moveSlider(key, touch.clientX, trackEl);
      dbg(key + ' touch start');
    }, {passive: false});

    trackEl.addEventListener('touchmove', function(e) {
      e.preventDefault();
      e.stopPropagation();
      var touch = e.touches[0];
      moveSlider(key, touch.clientX, trackEl);
    }, {passive: false});

    trackEl.addEventListener('touchend', function(e) {
      knobEl.classList.remove('big');
      dbg(key + ' = ' + val[key]);
    });

    trackEl.addEventListener('touchcancel', function() {
      knobEl.classList.remove('big');
    });

    // Mouse (desktop)
    var mouseDown = false;
    trackEl.addEventListener('mousedown', function(e) {
      e.preventDefault();
      mouseDown = true;
      knobEl.classList.add('big');
      moveSlider(key, e.clientX, trackEl);
    });
    document.addEventListener('mousemove', function(e) {
      if (!mouseDown) return;
      moveSlider(key, e.clientX, trackEl);
    });
    document.addEventListener('mouseup', function() {
      if (mouseDown) {
        mouseDown = false;
        knobEl.classList.remove('big');
      }
    });
  })(S.key, track, knob);
}

/* ========== SLIDER LOGIC ========== */
function getCfg(key) {
  for (var i = 0; i < SLIDERS.length; i++) {
    if (SLIDERS[i].key === key) return SLIDERS[i];
  }
  return null;
}

function moveSlider(key, clientX, trackEl) {
  var rect = trackEl.getBoundingClientRect();
  var pct = (clientX - rect.left) / rect.width;
  pct = Math.max(0, Math.min(1, pct));
  var cfg = getCfg(key);
  var raw = cfg.mn + pct * (cfg.mx - cfg.mn);
  var snapped = Math.round(raw / cfg.step) * cfg.step;
  snapped = Math.max(cfg.mn, Math.min(cfg.mx, snapped));
  setVal(key, snapped);
}

function setVal(key, v) {
  var cfg = getCfg(key);
  v = Math.max(cfg.mn, Math.min(cfg.mx, v));
  v = Math.round(v / cfg.step) * cfg.step;
  val[key] = v;

  var pct = (v - cfg.mn) / (cfg.mx - cfg.mn) * 100;
  var d = dom[key];

  d.fillEl.style.width = pct + '%';
  d.knobEl.style.left = pct + '%';
  d.valEl.textContent = cfg.fmt(v);

  drawWave();
  hiliteChips();
  updateBtn();
}

/* ========== PRESETS HIGHLIGHT ========== */
function hiliteChips() {
  var all = chipsDiv.querySelectorAll('.chip');
  for (var i = 0; i < all.length; i++) {
    var pk = all[i].getAttribute('data-pk');
    var p = PRESETS[pk];
    if (!p) continue;
    var ok = true;
    for (var k in p) {
      if (Math.abs(val[k] - p[k]) > 1) { ok = false; break; }
    }
    if (ok) all[i].classList.add('on');
    else all[i].classList.remove('on');
  }
}

/* ========== MAIN BUTTON ========== */
function isDefault() {
  for (var i = 0; i < SLIDERS.length; i++) {
    if (val[SLIDERS[i].key] !== SLIDERS[i].def) return false;
  }
  return true;
}

function updateBtn() {
  if (!tg) return;
  try {
    tg.MainButton.color = isDefault() ? '#3a3a4e' : '#7c5cfc';
  } catch(e) {}
}

function doApply() {
  dbg('doApply called, isDefault=' + isDefault());
  if (isDefault()) {
    if (tg) {
      try { tg.showAlert('–ò–∑–º–µ–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä'); } catch(e) { alert('–ò–∑–º–µ–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä'); }
    } else {
      alert('–ò–∑–º–µ–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä');
    }
    return;
  }

  var data = JSON.stringify({
    pitch: Number((val.pitch / 100).toFixed(2)),
    speed: Number((val.speed / 10).toFixed(1)),
    reverb: val.reverb,
    bass: val.bass
  });

  dbg('sendData: ' + data);

  if (tg) {
    try {
      tg.sendData(data);
    } catch(e) {
      dbg('sendData error: ' + e.message);
      alert('–û—à–∏–±–∫–∞: ' + e.message);
    }
  } else {
    alert('–î–∞–Ω–Ω—ã–µ (–Ω–µ –≤ Telegram): ' + data);
  }
}

/* ========== WAVEFORM ========== */
var wCanvas = document.getElementById('waveCanvas');
var wCtx = wCanvas.getContext('2d');
var wData = [];

function initWave() {
  var dpr = window.devicePixelRatio || 1;
  var w = wCanvas.offsetWidth;
  var h = wCanvas.offsetHeight;
  wCanvas.width = w * dpr;
  wCanvas.height = h * dpr;
  wCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

  wData = [];
  for (var i = 0; i < w; i++) {
    var t = i / w;
    var a = 0.3 + 0.7 * (
      Math.sin(t*12)*0.3 + Math.sin(t*28+1)*0.25 +
      Math.sin(t*60)*0.15 + Math.sin(t*120)*0.1 + Math.random()*0.2
    );
    wData.push(Math.max(0.05, Math.min(1, a)));
  }
  drawWave();
}

function drawWave() {
  var w = wCanvas.offsetWidth;
  var h = wCanvas.offsetHeight;
  wCtx.clearRect(0, 0, w, h);

  var pF = val.pitch / 100;
  var sF = val.speed / 10;
  var bF = val.bass / 15;
  var rF = val.reverb / 30;

  for (var i = 0; i < w; i++) {
    var si = Math.floor((i * sF) % wData.length);
    var a = wData[si] * pF;
    a += bF * 0.3 * Math.sin(i * 0.02);
    a = Math.max(0.02, Math.min(1, a));

    var bH = a * h * 0.85;
    var y = (h - bH) / 2;

    if (rF > 0) {
      wCtx.fillStyle = 'rgba(124,92,252,' + (rF*0.15) + ')';
      var eH = a * rF * 0.4 * h * 0.85;
      wCtx.fillRect(i, (h-eH)/2, 1, eH);
    }

    var g = wCtx.createLinearGradient(0, y, 0, y+bH);
    g.addColorStop(0, 'rgba(124,92,252,' + (0.5+a*0.5) + ')');
    g.addColorStop(0.5, 'rgba(168,85,247,' + (0.7+a*0.3) + ')');
    g.addColorStop(1, 'rgba(252,92,140,' + (0.3+bF*0.5) + ')');
    wCtx.fillStyle = g;
    wCtx.fillRect(i, y, 1, bH);
  }
}

/* ========== INIT ========== */
window.addEventListener('resize', initWave);
initWave();
for (var i = 0; i < SLIDERS.length; i++) {
  setVal(SLIDERS[i].key, SLIDERS[i].def);
}
dbg('init done, tg=' + (tg ? 'yes' : 'no'));
</script>
</body>
</html>
